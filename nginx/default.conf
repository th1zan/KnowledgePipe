# =============================================================================
# Weekly Digest - Nginx Configuration
# =============================================================================
# Reverse proxy pour:
#   - /feeds/* -> sync-orchestrator (flux RSS)
#   - /audio/* -> fichiers audio locaux
#   - /health  -> health check Nginx
# =============================================================================

upstream orchestrator {
    server sync-orchestrator:8002;
    keepalive 32;
}

server {
    listen 80;
    server_name _;

    # Logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip compression pour les feeds RSS
    gzip on;
    gzip_types application/rss+xml application/xml text/xml application/json;
    gzip_min_length 1000;

    # -------------------------------------------------------------------------
    # Health check endpoint
    # -------------------------------------------------------------------------
    location = /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # -------------------------------------------------------------------------
    # Feeds RSS - Proxy vers sync-orchestrator
    # -------------------------------------------------------------------------
    location /feeds/ {
        proxy_pass http://orchestrator/feeds/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Cache des feeds RSS (5 minutes)
        proxy_cache_valid 200 5m;
        proxy_cache_use_stale error timeout updating;

        # Headers CORS pour les readers RSS
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";

        # Content-Type correct pour RSS
        add_header Content-Type "application/rss+xml; charset=utf-8" always;
    }

    # -------------------------------------------------------------------------
    # Audio files - Fichiers statiques
    # -------------------------------------------------------------------------
    location /audio/ {
        alias /audio/;
        
        # Types MIME audio
        types {
            audio/mpeg mp3;
            audio/ogg ogg;
            audio/wav wav;
            audio/x-m4a m4a;
        }

        # Support Range requests pour streaming
        add_header Accept-Ranges bytes;

        # Cache navigateur (7 jours pour les fichiers audio)
        expires 7d;
        add_header Cache-Control "public, immutable";

        # Headers CORS pour les players audio
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";

        # Fallback si fichier non trouve
        try_files $uri =404;
    }

    # -------------------------------------------------------------------------
    # API orchestrator - Proxy pour debug/admin
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://orchestrator/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeout plus long pour les syncs manuelles
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }

    # -------------------------------------------------------------------------
    # Documentation API (Swagger)
    # -------------------------------------------------------------------------
    location /docs {
        proxy_pass http://orchestrator/docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /openapi.json {
        proxy_pass http://orchestrator/openapi.json;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    location /redoc {
        proxy_pass http://orchestrator/redoc;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # -------------------------------------------------------------------------
    # Root - Page d'information
    # -------------------------------------------------------------------------
    location = / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Weekly Digest</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        a { color: #0066cc; }
        .feeds { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
        code { background: #e0e0e0; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Weekly Digest</h1>
    <p>Syntheses textuelles et podcasts automatiques.</p>
    
    <div class="feeds">
        <h2>Flux RSS</h2>
        <ul>
            <li><a href="/feeds/podcast.rss">Podcast RSS</a> - Episodes audio hebdomadaires</li>
            <li><a href="/feeds/reviews.rss">Reviews RSS</a> - Syntheses textuelles</li>
        </ul>
    </div>
    
    <h2>Services</h2>
    <ul>
        <li><a href="http://localhost:8000">Readeck</a> - Gestion des bookmarks</li>
        <li><a href="http://localhost:3000">Open Notebook</a> - Interface notebooks</li>
        <li><a href="/docs">API Documentation</a> - Swagger UI</li>
    </ul>
    
    <h2>Status</h2>
    <p>API Health: <code>GET /api/health</code></p>
    <p>Detailed: <code>GET /api/health/detailed</code></p>
</body>
</html>';
    }

    # -------------------------------------------------------------------------
    # Deny access to hidden files
    # -------------------------------------------------------------------------
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
