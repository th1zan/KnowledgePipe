# =============================================================================
# Weekly Digest - Stack de production
# =============================================================================
# Usage:
#   docker compose up -d --build
#   docker compose logs -f sync-orchestrator
#
# Ports exposés:
#   - 80: Nginx (feeds RSS + audio)
#   - 8000: Readeck (interface web)
#   - 3000: Open Notebook Frontend
#   - 8002: sync-orchestrator API
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Readeck - Gestion des bookmarks avec extraction de contenu
  # ---------------------------------------------------------------------------
  readeck:
    image: codeberg.org/readeck/readeck:latest
    container_name: readeck
    restart: unless-stopped
    volumes:
      - readeck_data:/readeck
    environment:
      - READECK_LOG_LEVEL=info
      - READECK_SERVER_HOST=0.0.0.0
      - READECK_SERVER_PORT=8000
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/api/profile"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - weekly-digest

  # ---------------------------------------------------------------------------
  # Open Notebook - Backend (FastAPI)
  # ---------------------------------------------------------------------------
  open-notebook-backend:
    image: ghcr.io/lfnovo/open-notebook:latest
    container_name: open-notebook-backend
    restart: unless-stopped
    depends_on:
      surrealdb:
        condition: service_healthy
    environment:
      - OPEN_NOTEBOOK_PASSWORD=${OPEN_NOTEBOOK_PASSWORD}
      - SURREALDB_URL=ws://surrealdb:8000/rpc
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
      - SURREALDB_NAMESPACE=open_notebook
      - SURREALDB_DATABASE=open_notebook
      # LLM Configuration - ajuster selon votre provider
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # TTS Configuration
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
    volumes:
      - open_notebook_data:/app/data
    ports:
      - "5055:5055"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - weekly-digest

  # ---------------------------------------------------------------------------
  # Open Notebook - Frontend (Next.js)
  # ---------------------------------------------------------------------------
  open-notebook-frontend:
    image: ghcr.io/lfnovo/open-notebook-frontend:latest
    container_name: open-notebook-frontend
    restart: unless-stopped
    depends_on:
      - open-notebook-backend
    environment:
      - NEXT_PUBLIC_API_URL=http://open-notebook-backend:5055
    ports:
      - "3000:3000"
    networks:
      - weekly-digest

  # ---------------------------------------------------------------------------
  # SurrealDB - Base de données pour Open Notebook
  # ---------------------------------------------------------------------------
  surrealdb:
    image: surrealdb/surrealdb:latest
    container_name: surrealdb
    restart: unless-stopped
    command: start --user root --pass root file:/data/database.db
    volumes:
      - surrealdb_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - weekly-digest

  # ---------------------------------------------------------------------------
  # Sync Orchestrator - Service Python principal
  # ---------------------------------------------------------------------------
  sync-orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: sync-orchestrator
    restart: unless-stopped
    depends_on:
      readeck:
        condition: service_healthy
      open-notebook-backend:
        condition: service_healthy
    environment:
      # Readeck
      - READECK_URL=http://readeck:8000
      - READECK_TOKEN=${READECK_TOKEN}
      # Open Notebook
      - OPEN_NOTEBOOK_URL=http://open-notebook-backend:5055
      - OPEN_NOTEBOOK_PASSWORD=${OPEN_NOTEBOOK_PASSWORD}
      # RSS
      - RSS_FEEDS=${RSS_FEEDS}
      - RSS_FETCH_HOUR=${RSS_FETCH_HOUR:-8}
      # Scheduler
      - SYNC_DAY=${SYNC_DAY:-sunday}
      - SYNC_HOUR=${SYNC_HOUR:-23}
      # Audio
      - AUDIO_HOSTING=${AUDIO_HOSTING:-local}
      - AUDIO_LOCAL_PATH=/audio
      - AUDIO_PUBLIC_URL=${AUDIO_PUBLIC_URL:-http://localhost/audio}
      - BACKBLAZE_KEY_ID=${BACKBLAZE_KEY_ID:-}
      - BACKBLAZE_APPLICATION_KEY=${BACKBLAZE_APPLICATION_KEY:-}
      - BACKBLAZE_BUCKET=${BACKBLAZE_BUCKET:-}
      - BACKBLAZE_ENDPOINT=${BACKBLAZE_ENDPOINT:-}
      # Podcast profiles
      - PODCAST_EPISODE_PROFILE=${PODCAST_EPISODE_PROFILE:-default}
      - PODCAST_SPEAKER_PROFILE=${PODCAST_SPEAKER_PROFILE:-default}
      # Database
      - DATABASE_PATH=/data/state.db
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      # Timeouts
      - SOURCE_PROCESSING_TIMEOUT=${SOURCE_PROCESSING_TIMEOUT:-300}
      - PODCAST_GENERATION_TIMEOUT=${PODCAST_GENERATION_TIMEOUT:-600}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT:-30}
      # Retry
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - RETRY_DELAY=${RETRY_DELAY:-5}
    volumes:
      - orchestrator_data:/data
      - audio_data:/audio
    ports:
      - "8002:8002"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - weekly-digest

  # ---------------------------------------------------------------------------
  # Nginx - Reverse proxy pour feeds RSS et audio
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    depends_on:
      - sync-orchestrator
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - audio_data:/audio:ro
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - weekly-digest

# =============================================================================
# Volumes persistants
# =============================================================================
volumes:
  readeck_data:
    driver: local
  open_notebook_data:
    driver: local
  surrealdb_data:
    driver: local
  orchestrator_data:
    driver: local
  audio_data:
    driver: local

# =============================================================================
# Réseau
# =============================================================================
networks:
  weekly-digest:
    driver: bridge
